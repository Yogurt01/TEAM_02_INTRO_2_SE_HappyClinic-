<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đặt lịch khám | Happy Clinic</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Navbar chung -->
  <%- include('partials/navbar') %>

  <div class="max-w-3xl mx-auto mt-8">
    <!-- Khung chính cho form đặt lịch khám -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
      <div class="bg-blue-600 px-6 py-4">
        <h2 class="text-2xl font-semibold text-white">Đặt lịch khám</h2>
      </div>

      <div class="p-6 space-y-6">
        <% if (error) { %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <span><%= error %></span>
          </div>
        <% } %>
        <% if (success) { %>
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
            <span><%= success %></span>
          </div>
        <% } %>

        <!-- Form thêm lịch khám -->
        <form action="/appointments" method="POST" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Tên bệnh nhân -->
            <div>
              <label class="block text-gray-700 font-medium">Tên bệnh nhân</label>
              <input type="text" name="username" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Email -->
            <div>
              <label class="block text-gray-700 font-medium">Email</label>
              <input type="email" name="email" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Số điện thoại -->
            <div>
              <label class="block text-gray-700 font-medium">Số điện thoại</label>
              <input type="text" name="phone" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Chọn bác sĩ -->
            <div>
              <label class="block text-gray-700 font-medium">Chọn bác sĩ</label>
              <input type="text" name="doctor" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Khoa -->
            <div>
              <label class="block text-gray-700 font-medium">Khoa</label>
              <input type="text" name="department" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <!-- Ngày khám -->
            <div>
              <label class="block text-gray-700 font-medium">Ngày khám</label>
              <input type="date" name="date" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Giờ khám -->
            <div>
              <label class="block text-gray-700 font-medium">Giờ khám</label>
              <input type="time" name="time" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
            <!-- Triệu chứng -->
            <div>
              <label class="block text-gray-700 font-medium">Triệu chứng</label>
              <input type="text" name="symptoms" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required />
            </div>
          </div>

          <div class="flex justify-between pt-4">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded shadow">
              Thêm lịch khám
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bảng lịch khám đã đăng ký -->
    <h2 class="mt-10 text-xl font-semibold" style="border-bottom: 2px solid #3498db; padding-bottom: 5px; color: #2c3e50;">Lịch khám đã đăng ký</h2>

    <!-- Lọc trạng thái lịch khám -->
    <form id="filterForm" method="GET" action="/auth/availability#filterForm" class="filter-form" style="text-align: right;">
      <label for="filterStatus">Lọc theo trạng thái khám: </label>
      <select name="filterStatus" id="filterStatus" onchange="this.form.submit()">
        <option value="all" <%= filterStatus === 'all' ? 'selected' : '' %>>Tất cả</option>
        <option value="checked" <%= filterStatus === 'checked' ? 'selected' : '' %>>Đã khám</option>
        <option value="unchecked" <%= filterStatus === 'unchecked' ? 'selected' : '' %>>Chưa khám</option>
      </select>
    </form>

    <!-- Bảng hiển thị lịch khám -->
    <table class="w-full mt-6">
      <thead>
        <tr>
          <th>Mã bệnh nhân</th>
          <th>Ngày khám</th>
          <th>Giờ bắt đầu</th>
          <th>Giờ kết thúc</th>
          <th>Tên bệnh nhân</th>
          <th>Triệu chứng</th>
          <th>Trạng thái khám</th>
          <th>Đánh dấu đã khám</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <% slots.forEach(slot => { %>
          <tr>
            <td><%= slot.patientCode %></td>
            <td><%= slot.date %></td>
            <td><%= slot.startTime %></td>
            <td><%= slot.endTime %></td>
            <td><%= slot.patientName %></td>
            <td><%= slot.symptoms %></td>
            <td class="<%= slot.isChecked ? 'text-green-600' : 'text-red-600' %>">
              <%= slot.isChecked ? 'Đã khám' : 'Chưa khám' %>
            </td>
            <td>
              <% if (!slot.isChecked) { %>
                <form method="POST" action="/auth/availability/check/<%= slot.appointmentCode %>">
                  <button type="submit" class="bg-green-500 text-white py-1 px-3 rounded">Đánh dấu đã khám</button>
                </form>
              <% } else { %>
                <span>✓</span>
              <% } %>
            </td>
            <td>
              <form method="POST" action="/auth/availability/delete/<%= slot.appointmentCode %>" onsubmit="return confirm('Bạn có chắc chắn muốn xóa lịch khám này không?');" style="display:inline;">
                <button type="submit" class="bg-red-500 text-white py-1 px-3 rounded">Xóa</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</body>
</html>
<script>
  // Hàm để chỉnh sửa lịch khám
  function editSlot(appointmentCode, date, startTime, endTime, patientName, patientBirth, symptoms, email, phone, address) {
    // Hiển thị form chỉnh sửa với thông tin hiện tại
    document.getElementById('editAppointmentCode').value = appointmentCode;
    document.getElementById('editDate').value = date;
    document.getElementById('editStartTime').value = startTime;
    document.getElementById('editEndTime').value = endTime;
    document.getElementById('editPatientName').value = patientName;
    document.getElementById('editPatientBirth').value = patientBirth;
    document.getElementById('editSymptoms').value = symptoms;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    document.getElementById('editAddress').value = address;

    // Hiển thị modal chỉnh sửa
    document.getElementById('editModal').classList.remove('hidden');
  }
</script>